<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Customer Chat</title>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body { font-family: Arial, sans-serif; background: #fafafa; padding: 20px; }
    #chatBox { border: 1px solid #ccc; padding: 10px; height: 300px; overflow-y: scroll; background: #fff; }
    #msg { width: 70%; padding: 10px; }
    #sendBtn { padding: 10px; background: #007bff; color: #fff; border: none; cursor: pointer; }
    #sendBtn:hover { background: #0056b3; }
    img { max-width: 100%; border-radius: 5px; }
  </style>
</head>
<body>

<h2>ðŸ’¬ Customer Support Chat</h2>
<div id="chatBox"></div>
<br>
<input type="text" id="customerName" placeholder="Your Name" />
<br><br>
<input type="text" id="msg" placeholder="Type your message..." />
<button id="sendBtn">Send</button>
<input type="file" id="fileInput">
<button id="fileSend">ðŸ“Ž Send File</button>

<script>
  const socket = io();
  const chatBox = document.getElementById("chatBox");
  const msgInput = document.getElementById("msg");
  const sendBtn = document.getElementById("sendBtn");
  const fileInput = document.getElementById("fileInput");
  const fileSend = document.getElementById("fileSend");

  function addMessage(msg) {
    const div = document.createElement("div");
    let content = `<b>${msg.sender}:</b> ${msg.text || ""}`;
    if (msg.fileUrl) {
      if (/\.(jpg|png|gif)$/i.test(msg.fileUrl))
        content += `<br><img src="${msg.fileUrl}">`;
      else content += `<br><a href="${msg.fileUrl}" target="_blank">ðŸ“Ž Download File</a>`;
    }
    div.innerHTML = content;
    chatBox.appendChild(div);
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  socket.on("chatHistory", (data) => data.forEach(addMessage));
  socket.on("chatMessage", addMessage);

  sendBtn.addEventListener("click", () => {
    const text = msgInput.value.trim();
    if (!text) return;
    const sender = document.getElementById("customerName").value || "Customer";
    socket.emit("chatMessage", { sender, text, timestamp: Date.now() });
    msgInput.value = "";
  });

  fileSend.addEventListener("click", async () => {
    const file = fileInput.files[0];
    if (!file) return alert("Select a file first!");
    const formData = new FormData();
    formData.append("file", file);
    const res = await fetch("/api/upload", { method: "POST", body: formData });
    const data = await res.json();
    const sender = document.getElementById("customerName").value || "Customer";
    socket.emit("chatMessage", { sender, fileUrl: data.fileUrl, text: "", timestamp: Date.now() });
    fileInput.value = "";
  });
</script>

</body>
</html>
